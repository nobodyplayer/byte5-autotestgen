import asyncio

import models.state as state
import utils.llm_initial_util as llm_initial
import agent.generator as generator
from utils import agent_util
import logging

logging.basicConfig(
    level=logging.INFO, # 设置根logger的级别为DEBUG，能捕获所有级别的日志
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

# 创建一个我们自己应用的顶层logger（可选，但推荐）
main_logger = logging.getLogger(__name__)
main_logger.info("应用程序启动...")

text = """
5.1 功能概述
5.1.1 业务流程图
5.1.2 功能架构
5.2 功能说明
5.2.1 账号登录
5.2.1.1 业务流程
用户打开登录网址进入登录页面；
输入登录账号、密码、验证码进行登录；
5.2.1.2 页面原型
5.2.1.3 逻辑说明
账号输入框：输入账号后显示清空操作按钮，点击清空按钮清空已输入的账号；
密码输入框：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
验证码：验证码为4位随机的大写英文字母，单击验证码展示区域刷新验证码，验证码有效期为60秒；
所有输入框获取焦点时提示文字消失且边框变为绿色，失去焦点时恢复原状；
【登录】按钮：点击【登录】按钮时依次校验登录账号、密码、验证码，若某一项校验出问题则在对应输入框下方红字提醒用户错误原因，全部校验通过则成功登录并进入系统首页；
【找回密码】按钮：点击【找回密码】按钮跳转至找回密码页面；
账号首次成功登录时弹窗提示账号首次登录时需修改初始密码，点击【确定】按钮跳转至修改初始密码页面，初始密码修改后需要重新输入账号、密码、验证码进行登录；
5.2.2 重置初始密码
5.2.2.1 业务流程
用户初次成功登录账号后弹窗提示用户修改初始密码；
点击弹窗的【确定】按钮后页面跳转至重置初始密码页面；
5.2.2.2 页面原型
5.2.2.3 业务逻辑
新密码输入框：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
确认密码：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
验证码：点击【获取验证码】按钮向登录账号绑定手机号发送6位随机数字验证码，验证码已发送后【获取验证码】按钮展示60秒倒计时，倒计时结束后恢复原状，验证码有效期为60秒；
所有输入框获取焦点时提示文字消失且输入框边框变为绿色，失去焦点时恢复原状；
【取消】按钮：点击【取消】按钮取消修改初始密码，返回至登录页面；
【提交】按钮：点击【提交】按钮依次校验密码、验证码，若某一项校验出问题则在对应输入框下方红字提醒用户错误原因，全部校验通过则提示重置密码成功，然后返回至登录页面；
5.2.3 找回密码
5.2.3.1 业务流程
用户打开登录网址进入登录页面；
忘记登录密码后在登录页面页面点击【找回密码】按钮进入找回密码页面；
5.2.3.2 页面原型
5.2.3.3 业务逻辑
新密码输入框：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
确认密码：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
验证码：点击【获取验证码】按钮向登录账号绑定手机号发送6位随机数字验证码，验证码已发送后【获取验证码】按钮展示60秒倒计时，倒计时结束后恢复原状，验证码有效期为60秒；
所有输入框获取焦点时提示文字消失且输入框边框变为绿色，失去焦点时恢复原状；
【取消】按钮：点击【取消】按钮取消修改初始密码，返回至登录页面；
【提交】按钮：点击【提交】按钮依次校验密码、验证码，若某一项校验出问题则在对应输入框下方红字提醒用户错误原因，全部校验通过则提示重置密码成功，然后返回至登录页面；
5.2.4 修改密码
5.2.4.1 业务流程
用户成功登录账号；
在我的页面选择修改密码进入修改密码页面；
5.2.4.2 页面原型
5.2.4.3 业务逻辑
原密码输入框：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
新密码输入框：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
确认密码：输入密码后显示密码明文查看按钮及清空按钮，鼠标按下明文查看按钮密码明文展示，鼠标松开后密文展示，点击清空按钮清空已输入密码；
验证码：点击【获取验证码】按钮向登录账号绑定手机号发送6位随机数字验证码，验证码已发送后【获取验证码】按钮展示60秒倒计时，倒计时结束后恢复原状，验证码有效期为60秒；
所有输入框获取焦点时提示文字消失且输入框边框变为绿色，失去焦点时恢复原状；
【取消】按钮：点击【取消】按钮取消修改密码，返回至我的页面；
【提交】按钮：点击【提交】按钮依次校验密码、验证码，若某一项校验出问题则在对应输入框下方红字提醒用户错误原因，全部校验通过则提示重置密码成功；
"""

detector_result = {'账号登录': ['验证使用有效账号、密码和验证码点击登录可成功进入系统首页',
                                '验证首次登录成功后弹窗提示修改初始密码，点击【确定】跳转至重置初始密码页面',
                                '验证账号输入后显示清空按钮，点击清空按钮可清空已输入账号',
                                '验证密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入密码',
                                '验证点击验证码展示区域可刷新4位大写英文字母验证码',
                                '验证输入框获取焦点时提示文字消失且边框变为绿色，失去焦点时恢复原状',
                                '验证点击【找回密码】按钮可跳转至找回密码页面',
                                '验证账号输入框输入空值（null/空字符串）时点击登录，对应输入框下方显示错误提示',
                                '验证账号输入框输入空格字符串时点击登录，对应输入框下方显示错误提示',
                                '验证账号输入框输入超长字符（如超过系统限制长度）时点击登录，对应输入框下方显示错误提示',
                                '验证账号输入框输入特殊字符（如!@#$%^&*）时点击登录，对应输入框下方显示错误提示',
                                '验证密码输入框输入空值时点击登录，对应输入框下方显示错误提示',
                                '验证密码输入框输入空格字符串时点击登录，对应输入框下方显示错误提示',
                                '验证密码输入框输入超长字符时点击登录，对应输入框下方显示错误提示',
                                '验证密码输入框输入刚好等于系统规定的最小长度的字符时，校验通过',
                                '验证验证码输入3位大写字母时点击登录，对应输入框下方显示错误提示',
                                '验证验证码输入5位大写字母时点击登录，对应输入框下方显示错误提示',
                                '验证输入不存在的账号、正确密码和验证码时点击登录，账号输入框下方显示错误提示',
                                '验证输入存在的账号、错误密码和正确验证码时点击登录，密码输入框下方显示错误提示',
                                '验证输入正确账号、密码和错误验证码（如小写字母、数字、特殊字符、错误4位大写）时点击登录，验证码输入框下方显示错误提示',
                                '验证验证码生成后超过60秒输入并点击登录，显示验证码过期错误提示',
                                '验证点击验证码展示区域刷新后，旧验证码失效，使用旧验证码登录显示错误提示',
                                '验证点击登录按钮时网络中断，系统提示网络错误',
                                '验证点击登录按钮时服务器返回500错误，系统提示服务器错误',
                                '验证首次登录修改初始密码成功后，重新输入账号、密码、验证码可成功登录',
                                '验证点击【登录】按钮后，未完成请求前再次点击，按钮置灰不可点击',
                                '验证密码输入框输入包含特殊字符（如!@#$%^&*）的符合长度要求的密码时，点击登录按钮校验通过',
                                '验证账号输入框输入刚好等于系统规定最小长度的字符时，校验通过',
                                '验证密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                '验证验证码生成后刚好60秒时输入并点击登录，验证码有效',
                                '验证输入不存在的账号、错误密码和错误验证码时点击登录，仅账号输入框下方显示错误提示（符合依次校验逻辑）'],
                   '重置初始密码': ['验证首次登录成功后弹窗点击【确定】可跳转至重置初始密码页面',
                                    '验证输入符合要求的新密码、确认密码（与新密码一致）和有效验证码时点击【提交】，提示重置成功并返回登录页面',
                                    '验证新密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入新密码',
                                    '验证确认密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入确认密码',
                                    '验证点击【获取验证码】按钮向绑定手机号发送6位数字验证码，按钮显示60秒倒计时，倒计时结束后恢复原状',
                                    '验证输入框获取焦点时提示文字消失且边框变为绿色，失去焦点时恢复原状',
                                    '验证点击【取消】按钮可取消修改并返回登录页面',
                                    '验证新密码输入框输入空值时点击【提交】，对应输入框下方显示错误提示',
                                    '验证新密码输入框输入空格字符串时点击【提交】，对应输入框下方显示错误提示',
                                    '验证新密码输入框输入超长字符时点击【提交】，对应输入框下方显示错误提示',
                                    '验证新密码输入框输入刚好等于系统规定的最小长度的字符时，校验通过',
                                    '验证确认密码与新密码不一致时点击【提交】，确认密码输入框下方显示错误提示',
                                    '验证验证码输入3位数字时点击【提交】，对应输入框下方显示错误提示',
                                    '验证验证码输入5位数字时点击【提交】，对应输入框下方显示错误提示',
                                    '验证验证码发送后超过60秒输入并点击【提交】，显示验证码过期错误提示',
                                    '验证在60秒倒计时内多次点击【获取验证码】按钮，仅发送一次验证码且倒计时不重置',
                                    '验证点击【获取验证码】按钮时网络中断，系统提示网络错误且按钮未进入倒计时',
                                    '验证点击【提交】按钮时网络中断，系统提示网络错误且未完成密码重置',
                                    '验证点击【提交】按钮时服务器返回500错误，系统提示服务器错误且未完成密码重置',
                                    '验证点击【提交】按钮后，未完成请求前再次点击，按钮置灰不可点击',
                                    '验证新密码输入框输入包含特殊字符（如!@#$%^&*）的符合长度要求的密码时，校验通过',
                                    '验证新密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                    '验证确认密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                    '验证验证码发送后刚好60秒时输入并点击【提交】，验证码有效',
                                    '验证【获取验证码】按钮倒计时结束后再次点击，重新发送验证码并开始新的60秒倒计时',
                                    '验证非首次登录用户（已修改过初始密码）直接访问重置初始密码页面，系统跳转至登录页面或提示无权限',
                                    '验证重置初始密码时，新密码与原初始密码相同，点击【提交】后新密码输入框下方显示错误提示（符合首次登录需修改初始密码的要求）'],
                   '找回密码': ['验证登录页面点击【找回密码】按钮可跳转至找回密码页面',
                                '验证输入符合要求的新密码、确认密码（与新密码一致）和有效验证码时点击【提交】，提示重置成功并返回登录页面',
                                '验证新密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入新密码',
                                '验证确认密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入确认密码',
                                '验证点击【获取验证码】按钮向绑定手机号发送6位数字验证码，按钮显示60秒倒计时，倒计时结束后恢复原状',
                                '验证输入框获取焦点时提示文字消失且边框变为绿色，失去焦点时恢复原状',
                                '验证点击【取消】按钮可取消操作并返回登录页面',
                                '验证新密码输入框输入空值时点击【提交】，对应输入框下方显示错误提示',
                                '验证新密码输入框输入空格字符串时点击【提交】，对应输入框下方显示错误提示',
                                '验证新密码输入框输入超长字符时点击【提交】，对应输入框下方显示错误提示',
                                '验证新密码输入框输入刚好等于系统规定的最小长度的字符时，校验通过',
                                '验证确认密码与新密码不一致时点击【提交】，确认密码输入框下方显示错误提示',
                                '验证验证码输入3位数字时点击【提交】，对应输入框下方显示错误提示',
                                '验证验证码输入5位数字时点击【提交】，对应输入框下方显示错误提示',
                                '验证验证码发送后超过60秒输入并点击【提交】，显示验证码过期错误提示',
                                '验证在60秒倒计时内多次点击【获取验证码】按钮，仅发送一次验证码且倒计时不重置',
                                '验证点击【获取验证码】按钮时网络中断，系统提示网络错误且按钮未进入倒计时',
                                '验证点击【提交】按钮时网络中断，系统提示网络错误且未完成密码找回',
                                '验证点击【提交】按钮时服务器返回500错误，系统提示服务器错误且未完成密码找回',
                                '验证点击【提交】按钮后，未完成请求前再次点击，按钮置灰不可点击',
                                '验证新密码输入框输入包含特殊字符（如!@#$%^&*）的符合长度要求的密码时，校验通过',
                                '验证新密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                '验证确认密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                '验证验证码发送后刚好60秒时输入并点击【提交】，验证码有效',
                                '验证【获取验证码】按钮倒计时结束后再次点击，重新发送验证码并开始新的60秒倒计时'],
                   '修改密码': ['验证成功登录后在我的页面点击修改密码可进入修改密码页面',
                                '验证输入正确原密码、符合要求的新密码（与原密码不同）、确认密码（与新密码一致）和有效验证码时点击【提交】，提示修改成功',
                                '验证原密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入原密码',
                                '验证新密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入新密码',
                                '验证确认密码输入后显示明文查看按钮及清空按钮，鼠标按下明文查看按钮显示明文、松开恢复密文，点击清空按钮可清空已输入确认密码',
                                '验证点击【获取验证码】按钮向绑定手机号发送6位数字验证码，按钮显示60秒倒计时，倒计时结束后恢复原状',
                                '验证输入框获取焦点时提示文字消失且边框变为绿色，失去焦点时恢复原状',
                                '验证点击【取消】按钮可取消修改并返回我的页面',
                                '验证原密码输入框输入空值时点击【提交】，对应输入框下方显示错误提示',
                                '验证原密码输入框输入空格字符串时点击【提交】，对应输入框下方显示错误提示',
                                '验证原密码输入框输入超长字符时点击【提交】，对应输入框下方显示错误提示',
                                '验证原密码输入框输入刚好等于系统规定的最小长度的字符时，校验通过',
                                '验证输入错误原密码、正确新密码、确认密码和验证码时点击【提交】，原密码输入框下方显示错误提示',
                                '验证新密码输入框输入空值时点击【提交】，对应输入框下方显示错误提示',
                                '验证新密码输入框输入空格字符串时点击【提交】，对应输入框下方显示错误提示',
                                '验证新密码输入框输入超长字符时点击【提交】，对应输入框下方显示错误提示',
                                '验证新密码输入框输入刚好等于系统规定的最小长度的字符时，校验通过',
                                '验证确认密码与新密码不一致时点击【提交】，确认密码输入框下方显示错误提示',
                                '验证新密码与原密码相同时点击【提交】，新密码输入框下方显示错误提示',
                                '验证验证码输入3位数字时点击【提交】，对应输入框下方显示错误提示',
                                '验证验证码输入5位数字时点击【提交】，对应输入框下方显示错误提示',
                                '验证验证码发送后超过60秒输入并点击【提交】，显示验证码过期错误提示',
                                '验证在60秒倒计时内多次点击【获取验证码】按钮，仅发送一次验证码且倒计时不重置',
                                '验证点击【获取验证码】按钮时网络中断，系统提示网络错误且按钮未进入倒计时',
                                '验证点击【提交】按钮时网络中断，系统提示网络错误且未完成密码修改',
                                '验证点击【提交】按钮时服务器返回500错误，系统提示服务器错误且未完成密码修改',
                                '验证点击【提交】按钮后，未完成请求前再次点击，按钮置灰不可点击',
                                '验证原密码输入框输入包含特殊字符（如!@#$%^&*）的正确密码时，校验通过',
                                '验证新密码输入框输入包含特殊字符（如!@#$%^&*）的符合长度要求的密码时，校验通过',
                                '验证原密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                '验证新密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                '验证确认密码输入框的明文查看按钮，鼠标按下后移动至按钮外松开，密码恢复为密文展示',
                                '验证验证码发送后刚好60秒时输入并点击【提交】，验证码有效',
                                '验证【获取验证码】按钮倒计时结束后再次点击，重新发送验证码并开始新的60秒倒计时',
                                '验证未登录用户直接访问修改密码页面，系统跳转至登录页面或提示无权限']
                   }


async def run():
    sta = state.create_default_state()
    sta["prd_content"] = text
    sta["detected_test_point_dict"] = detector_result
    sta["detected_test_point_list"] = agent_util.test_case_number(sta["detected_test_point_dict"])
    llm, embeddings = llm_initial.initialize_llm("Volcengine", "doubao-Seed-1.6-flash", "doubao-embedding")
    # detected = generator.analyser_agent_node(sta, llm)
    # sta["detected_testPoint"] = detected
    generated = await generator.generator_agent_node(sta, llm, embeddings)
    print(generated)


if __name__ == "__main__":
    asyncio.run(run())
